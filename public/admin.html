<!DOCTYPE html>
<html lang="mk">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Diabetic Products Certification System</title>
  <style>
    
    :root {
      --primary: #0f172a;
      --primary-dark: #020617;
      --secondary: #2563eb;
      --light: #f9fafb;
      --light-gray: #e5e7eb;
      --dark: #0f172a;
      --dark-gray: #6b7280;
      --success: #16a34a;
      --danger: #dc2626;
      --warning: #f97316;
      --info: #0ea5e9;
    }

    body {
      font-family: 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      background-color: #f5f7fa;
      color: #34495e;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      background: var(--primary);
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      border-bottom: 1px solid var(--primary-dark);
    }
    .header h1 {
      margin: 0;
      font-weight: 500;
    }
    .logout-btn {
      color: white;
      background: rgba(255,255,255,0.15);
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.2s ease;
      border: 1px solid rgba(255,255,255,0.1);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .logout-btn:hover {
      background: rgba(255,255,255,0.25);
      text-decoration: none;
      transform: translateY(-1px);
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 20px;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.05);
    }
    th, td {
      border-bottom: 1px solid #e0e0e0;
      padding: 15px 20px;
      text-align: left;
      vertical-align: middle;
    }
    th {
      background: var(--primary);
      color: white;
      font-weight: 500;
    }
    tr:nth-child(even) {
      background-color: var(--light-gray);
    }
    tr:hover {
      background-color: rgba(52, 152, 219, 0.05);
    }
    select, button, a {
      padding: 10px 16px;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    button {
      cursor: pointer;
      transition: all 0.2s;
      min-width: 100px;
    }
    .save-btn {
      background-color: var(--success);
      color: white;
      border: none;
      margin-left: 8px;
    }
    .save-btn:hover {
      background-color: #228176;
    }
    .issue-btn {
      background-color: var(--primary);
      color: white;
      border: none;
    }
    .issue-btn:hover {
      background-color: #005b91;
    }
    button[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .action-bar, {
      display: flex;
      gap: 10px;
      margin: 20px 0;
    }
.search-section {
  display: flex;
  justify-content: center;  /* –Ω–æ–≤–æ */
  margin: 20px 0;
}

    .filter-options {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      margin-bottom: 20px;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.05);
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .filter-group h4 {
      margin: 0 0 5px 0;
      font-weight: 500;
      color: var(--dark);
    }
    .filter-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #555;
      cursor: pointer;
    }

    #searchField {
      flex-grow: 1;
      padding: 10px 15px;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 14px;
      background: var(--search-bg);
    }

    .filter-group input[type="text"] {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: var(--search-bg);
    }
    .refresh-btn {
      background-color: var(--secondary);
      color: white;
      border: none;
    }
    .logs-btn {
      background-color: var(--warning);
      color: var(--dark);
      border: none;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.05);
    }
	#appsTable {
  width: calc(100% + 40px);
  margin-left: 20px;
  margin-right: 20px;
}
#logsTable {
  width: calc(100% + 40px);
  margin-left: -20px;
  margin-right: -20px;
}
/* –°–∞–º–æ –∑–∞ –¥–µ–ª–æ—Ç –∫–∞–¥–µ —Ç–∏ –µ —Ç–∞–±–µ–ª–∞—Ç–∞: */
.container.full-width {
  max-width: none;
  padding: 0;
}

  </style>
</head>
<body>
      <header style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 2rem 1rem; text-align: center;">
      <div style="max-width: 800px; margin: 0 auto;">
        <img src="/logo.jpg" alt="DIAB-REG Logo" style="height: 100px; margin-bottom: 1rem;">
        <h1 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem; color: white;">–°–∏—Å—Ç–µ–º –∑–∞ —Å—Ç–∞–Ω–¥–∞—Ä–¥–∏–∑–∏—Ä–∞–Ω–∏ –ø–æ—Ç–≤—Ä–¥–∏ –∏ —Ä–µ–≥—É–ª–∞—Ü–∏—ò–∞</h1>
        <p style="font-size: 1.1rem; opacity: 0.9; margin: 0;">
          –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏ –Ω–∞–º–µ–Ω–µ—Ç–∏ –∑–∞ —Å–∏—Ç–µ –ª–∏—Ü–∞ —Å–æ –¥–∏—ò–∞–±–µ—Ç–µ—Å
        </p><BR><BR>
<h1 style="font-size: 3rem; font-weight: 700; margin: 0 0 0.5rem; color: white;">–ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–°–ö–ò –ü–ê–ù–ï–õ</h1>
       
      </div>
    </header>
  <div class="container">
    <div class="action-bar">
      <button id="refreshBtn" class="refresh-btn">‚ü≥ Refresh Data</button>
      <button id="toggleLogsBtn" class="logs-btn">üìã Show Logs</button>
    </div>

    <div id="logsSection" class="card" style="display:none;">
      <h2>Administrative Action Logs</h2>
    <table id="logsTable">
      <thead>
        <tr>
          <th>–ö–æ—Ä–∏—Å–Ω–∏–∫</th><th>–ê–∫—Ü–∏—ò–∞</th><th>Item ID</th><th>–í—Ä–µ–º–µ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

    <div class="card">
      <h2>Product Certification Applications</h2>
      
      <div class="search-section">
        <div class="filter-options">
          <div class="filter-group">
            <h4>Filter by Status:</h4>
            <label><input type="checkbox" name="status" value="Pending" checked> Pending</label>
            <label><input type="checkbox" name="status" value="In Process" checked> In Process</label>
            <label><input type="checkbox" name="status" value="Certifying" checked> Confirming</label>
            <label><input type="checkbox" name="status" value="Completed" checked> Completed</label>
          
		  </div>
		  <div class="filter-group">
  <h4>Filter by Date:</h4>
  <label>–û–¥:<input type="date" id="dateFrom" /></label>
  <label>–î–æ:<input type="date" id="dateTo" /></label>
</div>

          <div class="filter-group">
            <h4>Quick Search:</h4>
            <input type="text" id="searchField" placeholder="Company, Product, Email...">
          </div>
		  <div class="filter-group">
  <h4>Filter by Company:</h4>
  <select id="companyFilter">
    <option value="">All Companies</option>
  </select>
</div>
        </div>
      </div>
	  </div>
	   </div>
<div class="container full-width">
      <table id="appsTable">
    <thead>
      <tr>
        <th>ID</th><th>Created At</th><th>Company</th><th>Product</th><th>Contact</th><th>Email</th>
        <th>Status</th><th>Conf. No.</th><th>Files</th><th>Actions</th><th>Delete</th>
      </tr>
    </thead>
    <tbody></tbody>
      </table>
    </div>
 

 <script>
  // 1) –ö–µ—à–∏—Ä–∞—ò –µ–ª–µ–º–µ–Ω—Ç–∏
  const refreshBtn     = document.getElementById('refreshBtn');
  const companyFilter  = document.getElementById('companyFilter');
  const dateFrom       = document.getElementById('dateFrom');
  const dateTo         = document.getElementById('dateTo');
  const searchField    = document.getElementById('searchField');
  const statusChecks   = document.querySelectorAll('input[name="status"]');

let createdAtAsc = false;  // –ø–æ—á–µ—Ç–µ–Ω —Ä–µ–¥–æ—Å–ª–µ–¥: –Ω–∞—ò–Ω–æ–≤–∏ –Ω–∞–¥–æ–ª–µ

  // –ü–æ –≤—á–∏—Ç—É–≤–∞—ö–µ –Ω–∞ –∞–ø–ª–∏–∫–∞—Ü–∏–∏ –ø–æ–≤–∏–∫–∞—ò —ò–∞ –∏ –æ–≤–∞–∞ —Ñ—É–Ω–∫—Ü–∏—ò–∞
  function enableCreatedAtSort() {
    // —Å–µ–ª–µ–∫—Ç–∏—Ä–∞—ò –≥–æ TH –∑–∞ Created At (2-—Ä–∏ –∫–æ–ª–æ–Ω)
    const th = document.querySelector('#appsTable thead th:nth-child(2)');
    th.style.cursor = 'pointer';
    th.addEventListener('click', () => {
      const tbody = document.querySelector('#appsTable tbody');
      // –ø—Ä–µ–≤–µ–¥–∏ –≥–∏ —Ä–µ–¥–æ–≤–∏—Ç–µ –≤–æ –Ω–∏–∑–∞
      const rows = Array.from(tbody.querySelectorAll('tr'));
      // —Å–æ—Ä—Ç–∏—Ä–∞—ò –ø–æ –¥–∞—Ç—É–º
      rows.sort((a,b) => {
        const tdA = a.children[1].textContent;
        const tdB = b.children[1].textContent;
        const dateA = Date.parse(tdA.replace(/(\d+)\.(\d+)\.(\d+)/, '$2/$1/$3'));
        const dateB = Date.parse(tdB.replace(/(\d+)\.(\d+)\.(\d+)/, '$2/$1/$3'));
        return createdAtAsc ? dateA - dateB : dateB - dateA;
      });
      // –∏—Å—á–∏—Å—Ç–∏ tbody –∏ –ø—Ä–∏–∫–∞—á–∏ –≥–∏ —Å–æ—Ä—Ç–∏—Ä–∞–Ω–∏—Ç–µ —Ä–µ–¥–æ–≤–∏
      tbody.innerHTML = '';
      rows.forEach(r => tbody.appendChild(r));
      // –ø—Ä–µ–≤—Ä—Ç–∏ —Ñ–ª–∞–≥
      createdAtAsc = !createdAtAsc;
      // –ø—Ä–æ–º–µ–Ωa –Ω–∞ —Å—Ç—Ä–µ–ª–∫–∞ –≤–æ header (–æ–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ)
      th.textContent = `Created At ${createdAtAsc?'‚Üë':'‚Üì'}`;
    });
  }

  // –í–æ loadApplications(), –æ—Ç–∫–∞–∫–æ —ú–µ –≥–∏ –ø–æ—Å—Ç–∞–≤–∏—à —Ä–µ–¥–æ–≤–∏—Ç–µ:
  // ...
  loadApplications().then(() => {
    enableCreatedAtSort();
  });

  // 2) –§—É–Ω–∫—Ü–∏—ò–∞ —à—Ç–æ —ò–∞ –≤—á–∏—Ç—É–≤–∞ —Ç–∞–±–µ–ª–∞—Ç–∞ –∏ –ø–æ–ø–æ–ª–Ω—É–≤–∞ dropdown-–æ—Ç
  async function loadApplications() {
    refreshBtn.disabled = true;
    try {
      const res  = await fetch('/api/admin/applications?_sort=-createdAt');
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const apps = await res.json();

      // 2a) –ü–æ–ø–æ–ª–Ω—É–≤–∞—ö–µ –Ω–∞ Filter by Company
      // –ò—Å—á–∏—Å—Ç–∏ –≥–∏ —Å—Ç–∞—Ä–∏ –æ–ø—Ü–∏–∏—Ç–µ (–æ—Å–≤–µ–Ω ‚ÄûAll Companies‚Äú)
      companyFilter.querySelectorAll('option:not([value=""])').forEach(o => o.remove());
      // –°–æ–±–µ—Ä–∏ —É–Ω–∏–∫–∞—Ç–Ω–∏ –∏–º–∏—ö–∞ –Ω–∞ –∫–æ–º–ø–∞–Ω–∏–∏—Ç–µ
      const companies = Array.from(new Set(apps.map(a => a.company.name))).sort();
      companies.forEach(name => {
        const opt = document.createElement('option');
        opt.value       = name;
        opt.textContent = name;
        companyFilter.appendChild(opt);
      });

      // 2b) –ü–æ–ø–æ–ª–Ω—É–≤–∞—ö–µ –Ω–∞ —Ç–∞–±–µ–ª–∞—Ç–∞
      const tbody = document.querySelector('#appsTable tbody');
      tbody.innerHTML = apps.length
        ? apps.map(app => {
            const files = (app.docs||[]).map(f =>
              `<a href="/uploads/${f}" target="_blank">${f}</a>`
            ).join('<br>') || '-';

            const cert = app.cert_number
              ? `<a href="/api/certificate/pdf/${app._id}" target="_blank">${app.cert_number}</a>`
              : '-';

            const issueDis = app.status==='Completed' ? '' : 'disabled';

            return `
              <tr>
                <td>${app._id}</td>
                <td>${(function(){
                  const ts = app.createdAt
                           ? new Date(app.createdAt)
                           : new Date(parseInt(app._id.substring(0,8),16)*1000);
                  return ts.toLocaleString('mk-MK');
                })()}</td>
                <td>${app.company.name} (${app.company.matichen_broj})</td>
                <td>${app.product}</td>
                <td>${app.contact}</td>
                <td>${app.email}</td>
                <td>
                  <select data-id="${app._id}" class="status-select">
                    ${['Pending','In Process','Certifying','Completed']
                      .map(s=>`<option value="${s}" ${app.status===s?'selected':''}>${s}</option>`)
                      .join('')}
                  </select>
                  <button class="save-btn" data-id="${app._id}" disabled>Save</button>
                </td>
                <td>${cert}</td>
                <td>${files}</td>
                <td>
                  <button data-id="${app._id}" class="issue-btn" ${issueDis}>Issue Cert</button>
                  <button onclick="
                    window.location.href =
                      'mailto:${app.email}?subject=' +
                      encodeURIComponent('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—ò–∞ –∑–∞ –ø—Ä–æ–¥—É–∫—Ç ${app.product}')
                  ">–ò—Å–ø—Ä–∞—Ç–∏</button>
                </td>
				 <td>
    <a href="#" class="delete-link" data-id="${app._id}">Delete</a>
 </td>
              </tr>`;
          }).join('')
        : '<tr><td colspan="10">–ù–µ–º–∞ –∞–ø–ª–∏–∫–∞—Ü–∏–∏.</td></tr>';

      // —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç –∑–∞ Save/Issue –∫–æ–ø—á–∏—ö–∞—Ç–∞
      document.querySelectorAll('.status-select').forEach(sel => {
        sel.addEventListener('change', () => {
          document.querySelector(`.save-btn[data-id="${sel.dataset.id}"]`).disabled = false;
        });
      });
      document.querySelectorAll('.save-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    const id  = btn.dataset.id;
    const sel = document.querySelector(`.status-select[data-id="${id}"]`);

    // –ø–æ–±–∞—Ä–∞—ò –ø–æ—Ä–∞–∫–∞ –¥–æ–¥–µ–∫–∞ –Ω–µ –µ >=180 chars –∏–ª–∏ –∫–æ—Ä–∏—Å–Ω–∏–∫–æ—Ç –Ω–µ –æ—Ç–∫–∞–∂–µ
    let msg;
    do {
      msg = prompt('–í–Ω–µ—Å–µ—Ç–µ –æ–±—ò–∞—Å–Ω—É–≤–∞—ö–µ (–º–∏–Ω–∏–º—É–º 180 –∫–∞—Ä–∞–∫—Ç–µ—Ä–∏):');
      if (msg === null) return;                   // –∫–æ—Ä–∏—Å–Ω–∏–∫–æ—Ç –æ—Ç–∫–∞–∂–∞
      if (msg.length < 180) {
        alert(`–¢–µ–∫—Å—Ç–æ—Ç –µ –ø–æ–∫—Ä–∞—Ç–æ–∫ –æ–¥ 180 –∫–∞—Ä–∞–∫—Ç–µ—Ä–∏ (${msg.length}).`);
      }
    } while (msg.length < 180);

    // –ø—Ä–∞—ú–∞–º–µ –Ω–æ–≤–æ —Ç–µ–ª–æ —Å–æ message
    try {
      const res = await fetch(`/api/admin/applications/${id}/status`, {
        method: 'PATCH',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ status: sel.value, message: msg })
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      loadApplications();
    } catch(e) {
      alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ Save: ' + e.message);
    }
  });
});

      document.querySelectorAll('.issue-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          window.open(`/api/certificate/pdf/${btn.dataset.id}`, '_blank');
        });
      });
document.querySelectorAll('.delete-link').forEach(link => {
  link.addEventListener('click', async e => {
    e.preventDefault();
    // –ü—Ä–æ–∑–æ—Ä–µ—Ü –∑–∞ –ø–æ—Ç–≤—Ä–¥–∞ (OK = –î–∞, Cancel = –ù–µ)
    if (confirm('–î–∞–ª–∏ —Å—Ç–µ —Å–∏–≥—É—Ä–Ω–∏ –¥–µ–∫–∞ —Å–∞–∫–∞—Ç–µ –¥–∞ –∏–∑–±—Ä–∏—à–µ—Ç–µ –æ–≤–∞–∞ –∞–ø–ª–∏–∫–∞—Ü–∏—ò–∞?')) {
      try {
        const res = await fetch(`/api/admin/applications/${link.dataset.id}`, {
          method: 'DELETE'
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        // –ü—Ä–µ–∑–µ–º–∏ —ò–∞ —Ç–∞–±–µ–ª–∞—Ç–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ
        loadApplications();
      } catch (err) {
        alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –±—Ä–∏—à–µ—ö–µ: ' + err.message);
      }
    }
    // –ê–∫–æ –∫–æ—Ä–∏—Å–Ω–∏–∫–æ—Ç –∫–ª–∏–∫–Ω–µ ‚Äû–ù–µ‚Äú, –Ω–µ –ø—Ä–∞–≤–∏–º–µ –Ω–∏—à—Ç–æ
  });
});
    } catch(e) {
      alert('–ù–µ —É—Å–ø–µ–∞ –¥–∞ —Å–µ –≤—á–∏—Ç–∞–∞—Ç –∞–ø–ª–∏–∫–∞—Ü–∏–∏—Ç–µ: ' + e.message);
    } finally {
      refreshBtn.disabled = false;
    }
  }

  // 3) –§—É–Ω–∫—Ü–∏—ò–∞ –∑–∞ —Ñ–∏–ª—Ç—Ä–∏—Ä–∞—ö–µ
  function filterApplications() {
    const searchText      = searchField.value.toLowerCase();
    const statusFilters   = Array.from(statusChecks).filter(cb=>cb.checked).map(cb=>cb.value);
    const selectedCompany = companyFilter.value;
    const fromTs          = dateFrom.value ? new Date(dateFrom.value).getTime() : null;
    const toTs            = dateTo.value   ? new Date(dateTo.value).getTime()   : null;

    document.querySelectorAll('#appsTable tbody tr').forEach(row => {
      const cells = row.querySelectorAll('td');
      let ok = true;

      // —Å—Ç–∞—Ç—É—Å
      const status = row.querySelector('.status-select').value;
      if (!statusFilters.includes(status)) ok = false;

      // —Ç–µ–∫—Å—Ç
      if (ok && searchText) {
        ok = [2,3,4,5,7].some(i =>
          cells[i].textContent.toLowerCase().includes(searchText)
        );
      }

      // –∫–æ–º–ø–∞–Ω–∏—ò–∞
      if (ok && selectedCompany) {
        // cells[2] = "Name (–º–∞—Ç–∏—á–µ–Ω –±—Ä–æ—ò)"
        const nameOnly = cells[2].textContent.replace(/\s*\(.*\)/, '');
        if (nameOnly !== selectedCompany) ok = false;
      }

      // –¥–∞—Ç—É–º
      if (ok && (fromTs || toTs)) {
        const dateCell = cells[1].textContent;
        const cellTs   = new Date(
          dateCell.replace(/(\d+)\.(\d+)\.(\d+),/, '$2/$1/$3,')
        ).getTime();
        if (fromTs !== null && cellTs < fromTs) ok = false;
        if (toTs   !== null && cellTs > toTs + 24*3600*1000 -1) ok = false;
      }

      row.style.display = ok ? '' : 'none';
    });
  }

  // 4) –°–ª—É—à–∞—á–∏ –∑–∞ —Å–∏—Ç–µ —Ñ–∏–ª—Ç—Ä–∏ –∏ –∫–æ–ø—á–∏—ö–∞
  refreshBtn.addEventListener('click', loadApplications);
  companyFilter.addEventListener('change', filterApplications);
  dateFrom.addEventListener('change', filterApplications);
  dateTo.addEventListener('change', filterApplications);
  searchField.addEventListener('input', filterApplications);
  statusChecks.forEach(cb => cb.addEventListener('change', filterApplications));

  
  // 5) –ü—Ä–≤–∏—á–Ω–æ –≤—á–∏—Ç—É–≤–∞—ö–µ –∏ –æ–≥—Ä–∞–Ω–∏—á—É–≤–∞—ö–µ –Ω–∞ —Å—Ç–∞—Ç—É—Å–∏ (–Ω–µ –≤—Ä–∞—ú–∞–º–µ –Ω–∞–Ω–∞–∑–∞–¥)
  function restrictStatusOptions() {
    document.querySelectorAll('.status-select').forEach(sel => {
      const opts = Array.from(sel.options).map(o => o.value);
      const curr = sel.value;
      const idx  = opts.indexOf(curr);
      sel.innerHTML = opts
        .filter((s, i) => i >= idx)
        .map(s => `<option value="${s}" ${s === curr ? 'selected' : ''}>${s}</option>`)
        .join('');
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadApplications().then(() => {
      enableCreatedAtSort();
      restrictStatusOptions();
    });
  });
</script>


</body>
</html>
